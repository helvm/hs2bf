S0 Hp Hs


pr #stack1S0
    while $S0-1
        locate -1

pr #stackNewS0
    while $S0
        locate 1

pr #stackTopS0
    while $S0+1
        locate 1

pr #stack1Hp
    while $Hp-1
        locate -1

pr #stackNewHp
    while $Hp
        locate 1

pr #stackTopHp
    while $Hp+1
        locate 1

pr #heap1Hp
    while $Hp-1
        alloc cnt
        copy $Hp-1 cnt
        while cnt
            val cnt -1
            locate -1
        delete cnt

pr #heapNewHp/addr
    while $Hp
        alloc cnt
        copy $Hp cnt
        while cnt
            val cnt -1
            locate 1
        delete cnt
    copy $Hp-2 addr
    val addr 1

pr #heapNew_Hp
    while $Hp
        alloc cnt
        copy $Hp cnt
        while cnt
            val cnt -1
            locate 1
        delete cnt

pr #heapTopHp
    while $Hp
        alloc cnt
        copy $Hp cnt
        while cnt
            val cnt -1
            locate 1
        delete cnt
    alloc cnt
    copy $Hp-1 cnt
    while cnt
        val cnt -1
        locate -1
    delete cnt

pr #heapRefHp/addr
    val addr -1
    while addr
        val addr -1
        alloc cnt
        copy $Hp cnt
        while cnt
            val cnt -1
            locate 1
        delete cnt

pr #heap1Hs
    while $Hs-1
        alloc cnt
        copy $Hs-1 cnt
        while cnt
            val cnt -1
            locate -1
        delete cnt

pr #heapNewHs/addr
    while $Hs
        alloc cnt
        copy $Hs cnt
        while cnt
            val cnt -1
            locate 1
        delete cnt
    copy $Hs-2 addr
    val addr 1

pr #heapNew_Hs
    while $Hs
        alloc cnt
        copy $Hs cnt
        while cnt
            val cnt -1
            locate 1
        delete cnt

pr #heapTopHs
    while $Hs
        alloc cnt
        copy $Hs cnt
        while cnt
            val cnt -1
            locate 1
        delete cnt
    alloc cnt
    copy $Hs-1 cnt
    while cnt
        val cnt -1
        locate -1
    delete cnt

pr #heapRefHs/addr
    val addr -1
    while addr
        val addr -1
        alloc cnt
        copy $Hs cnt
        while cnt
            val cnt -1
            locate 1
        delete cnt

pr #gc
    inline #gcTransfer
    inline #gcMark
    inline #gcCopy
    inline #gcIndex
    inline #gcRewrite

pr #gcTransfer
    while $Hp
        alloc cnt
        copy $Hp cnt
        while cnt
            clear $Hs
            move $Hp $Hs
            val cnt -1
            locate 1
        delete cnt
    clear $Hs
    inline #heap1Hs

pr #gcMark
    -- init frontiers
    while $S0
        clear $Hp
        copy $S0 $Hp
        locate 1
    clear $Hp
    locate -1
    inline #stack1S0
    -- top to bottom
    inline #stackTopHp
    while $Hp
        alloc addr
        move $Hp addr
        inline #stack1Hp
        inline #heapRefHs addr
        delete addr
        -- already visited?
        alloc gf
        move $Hs+1 gf
        val $Hs+1 1
        dispatch gf
            0
                alloc ntag
                copy $Hs+2 ntag
                dispatch ntag
                    0
                        alloc t1
                        copy $Hs+3 t1
                        alloc t2
                        copy $Hs+4 t2
                        inline #heap1Hs
                        inline #stackNewHp
                        move t1 $Hp
                        delete t1
                        move t2 $Hp+1
                        delete t2
                        clear $Hp+2
                        locate 1
                    1
                        inline #heap1Hs
                        inline #stackTopHp
                    2
                        inline #heap1Hs
                        inline #stackTopHp
                    3
                        alloc sz
                        copy $Hs sz
                        dispatch sz
                            6
                                inline #heap1Hs
                                inline #stackNewHp
                                clear $Hp
                                locate -1
                        delete sz
                delete ntag
            1
                inline #heap1Hs
                inline #stackTopHp
        delete gf

pr #gcCopy
    while $Hs
        alloc flag
        move $Hs+1 flag
        dispatch flag
            0
                alloc cnt
                copy $Hs cnt
                while cnt
                    val cnt -1
                    locate 1
                delete cnt
            1
                alloc size
                copy $Hs size
                dispatch size
                    6
                        alloc t1
                        move $Hs+2 t1
                        alloc t2
                        move $Hs+3 t2
                        alloc t3
                        move $Hs+4 t3
                        alloc t4
                        copy $Hs+5 t4
                        inline #heap1Hs
                        inline #heapNew_Hp
                        move t4 $Hp $Hp+5
                        delete t4
                        move t1 $Hp+2
                        delete t1
                        move t2 $Hp+3
                        delete t2
                        move t3 $Hp+4
                        delete t3
                        clear $Hp+1
                        clear $Hp+6
                        inline #heap1Hp
                    7
                        alloc t1
                        move $Hs+2 t1
                        alloc t2
                        move $Hs+3 t2
                        alloc t3
                        move $Hs+4 t3
                        alloc t4
                        move $Hs+5 t4
                        alloc t5
                        copy $Hs+6 t5
                        inline #heap1Hs
                        inline #heapNew_Hp
                        move t5 $Hp $Hp+6
                        delete t5
                        move t1 $Hp+2
                        delete t1
                        move t2 $Hp+3
                        delete t2
                        move t3 $Hp+4
                        delete t3
                        move t4 $Hp+5
                        delete t4
                        clear $Hp+1
                        clear $Hp+7
                        inline #heap1Hp
                delete size
        delete flag
    inline #heap1Hs

pr #gcIndex
    alloc naddr
    while $Hp
        alloc cnt
        copy $Hp cnt
        while cnt
            val cnt -1
            locate 1
        delete cnt
        val naddr 1
    while naddr
        alloc ta
        copy naddr ta
        val ta 1
        inline #heapRefHp ta
        delete ta
        alloc oaddr
        copy $Hp-2 oaddr
        inline #heap1Hp
        -- Write index
        alloc cnt
        val oaddr -1
        copy oaddr cnt
        while cnt
            val cnt -1
            locate 1
        delete cnt
        clear $Hs
        copy naddr $Hs
        while oaddr
            val oaddr -1
            locate -1
        delete oaddr
        val naddr -1
    delete naddr
    -- Rewrite id field
    alloc naddr
    while $Hp
        alloc cnt
        copy $Hp cnt
        while cnt
            val cnt -1
            locate 1
        delete cnt
        val naddr 1
        clear $Hp-2
        copy naddr $Hp-2
    delete naddr
    inline #heap1Hp

pr #gcRewrite
    -- Rewrite heap
    while $Hp
        alloc ntag
        copy $Hp+2 ntag
        dispatch ntag
            0
                alloc t1
                move $Hp+3 t1
                alloc t2
                move $Hp+4 t2
                alloc ad
                copy $Hp+5 ad
                inline #heap1Hp
                inline #resolve t1
                inline #resolve t2
                inline #heapRefHp ad
                delete ad
                move t1 $Hp+3
                delete t1
                move t2 $Hp+4
                delete t2
                locate 7
            1
                locate 6
            2
                locate 6
            3
                alloc nsize
                copy $Hp nsize
                dispatch nsize
                    6
                        alloc ad
                        copy $Hp+4 ad
                        inline #heap1Hp
                        inline #heapRefHp ad
                        delete ad
                        locate 6
                delete nsize
        delete ntag
    inline #heap1Hp
    -- Rewrite stack
    alloc size
    while $S0
        val size 1
        locate 1
    while size
        locate -1
        val size -1
        alloc val
        move $S0 val
        inline #stack1S0
        inline #resolve val
        alloc cnt
        copy size cnt
        while cnt
            val cnt -1
            locate 1
        delete cnt
        move val $S0
        delete val
    delete size

pr #resolve/t
    val t -1
    alloc cnt
    copy t cnt
    while cnt
        val cnt -1
        locate 1
    move t cnt
    copy $Hs t
    while cnt
        val cnt -1
        locate -1
    delete cnt

pr ^
    inline %setupMemory
    inline %mainLoop

pr %setupMemory
    locate 1
    val $S0 1
    val $Hp 6
    val $Hp+1 0
    val $Hp+2 1
    val $Hp+3 2
    val $Hp+4 1
    val $Hp+5 6

pr %mainLoop
    alloc sc
    val sc 1
    while sc
        inline %eval sc
        inline %exec sc
    delete sc

pr %eval/sc
    inline #stack1S0
    inline #stackTopS0
    alloc addr
    copy $S0 addr
    inline #stack1S0
    inline #heapRefHp addr
    delete addr
    alloc tag
    copy $Hp+2 tag
    dispatch tag
        0
            inline %evalApp
        1
            inline %evalSC sc
        2
            inline %evalConst sc
        3
            inline %evalStr sc
    delete tag

pr %evalApp
    alloc addr
    copy $Hp+3 addr
    inline #heap1Hp
    inline #stackNewS0
    move addr $S0
    delete addr
    inline #stack1S0

pr %evalSC/sc
    val sc -1
    copy $Hp+3 sc
    inline #heap1Hp

pr %evalConst/sc
    inline #heap1Hp
    inline #stackTopS0
    while $S0-1
        val sc -1
        alloc addr
        move $S0-1 addr
        move $S0 $S0-1
        locate -1
        inline #stack1S0
        inline #heapRefHp addr
        delete addr
        copy $Hp+3 sc
        inline #heap1Hp

pr %evalStr/sc
    inline #heap1Hp
    inline #stackTopS0
    alloc root
    val root 1
    while $S0-1
        val sc -1
        val root -1
        alloc addr
        move $S0-1 addr
        move $S0 $S0-1
        locate -1
        inline #stack1S0
        inline #heapRefHp addr
        delete addr
        copy $Hp+3 sc
        inline #heap1Hp
    while root
        val root -1
        inline #stackTopS0
        alloc addr
        copy $S0 addr
        inline #stack1S0
        inline #heapRefHp addr
        delete addr
        inline %evalE sc
    delete root

pr %evalE/sc
    alloc stag
    copy $Hp+3 stag
    dispatch stag
        0
            alloc faddr
            copy $Hp+4 faddr
            alloc aaddr
            inline #heapNewHp aaddr
            val $Hp 7
            clear $Hp+1
            val $Hp+1 0
            clear $Hp+2
            val $Hp+2 0
            clear $Hp+3
            move faddr $Hp+3
            delete faddr
            clear $Hp+4
            clear $Hp+5
            clear $Hp+6
            copy aaddr $Hp+4 $Hp+5
            val $Hp+4 1
            val $Hp+6 7
            clear $Hp+7
            locate 7
            clear $Hp+1
            clear $Hp+2
            clear $Hp+3
            clear $Hp+4
            val $Hp 6
            val $Hp+1 2
            copy aaddr $Hp+4
            val $Hp+4 1
            val $Hp+5 6
            in $Hp+3
            clear $Hp+6
            inline #heap1Hp
            inline #stackTopS0
            clear $S0
            move aaddr $S0
            delete aaddr
            inline #stack1S0
        1
            alloc xaddr
            alloc kaddr
            copy $Hp+4 xaddr
            copy $Hp+5 kaddr
            inline #heap1Hp
            inline #heapRefHp xaddr
            delete xaddr
            out $Hp+3
            inline #heap1Hp
            inline #stackTopS0
            clear $S0
            move kaddr $S0
            delete kaddr
            inline #stack1S0
        2
            val sc -1
            inline #heap1Hp
            inline #stackTopS0
            clear $S0
    delete stag

pr #isEqual/x y f
    while x
        val x -1
        val y -1
    val f 1
    while y
        clear y
        val f -1

pr #rewriteS0/from to
    alloc test0
    copy $S0 test0
    alloc test1
    copy from test1
    alloc flag
    inline #isEqual test0 test1 flag
    delete test0
    delete test1
    while flag
        val flag -1
        clear $S0
        copy to $S0
    delete flag

pr #rewriteHp/from to
    alloc test0
    copy $Hp test0
    alloc test1
    copy from test1
    alloc flag
    inline #isEqual test0 test1 flag
    delete test0
    delete test1
    while flag
        val flag -1
        clear $Hp
        copy to $Hp
    delete flag

pr %exec/sc
    alloc cont
    while sc
        -- run GC before executing SC
        alloc sct
        copy sc sct
        val sct -1
        while sct
            clear sct
            inline #gc
        delete sct
        -- execute SC
        dispatch sc
            1
            3
                inline !Halt
            2
                inline !main
        val cont 1
    while cont
        val sc 1
        val cont -1
    delete cont

pr !Halt
    -- Pack 2 0
    -- nf 3 [2]
    alloc addr
    inline #heapNewHp addr
    clear $Hp+4
    move addr $Hp+4
    delete addr
    val $Hp 6
    clear $Hp+1
    val $Hp+1 0
    clear $Hp+2
    val $Hp+2 3
    clear $Hp+3
    val $Hp+3 2
    clear $Hp+5
    val $Hp+5 6
    clear $Hp+6
    alloc addr
    copy $Hp+4 addr
    inline #heap1Hp
    inline #stackNewS0
    move addr $S0
    delete addr
    -- Update 1
    alloc to
    move $S0 to
    locate -1
    alloc from
    copy $S0 from
    inline #stack1S0
    while $S0
        inline #rewriteS0 from to
        locate 1
    locate -1
    inline #stack1S0
    while $Hp
        alloc ntag
        copy $Hp+2 ntag
        dispatch ntag
            0
                locate 3
                inline #rewriteHp from to
                locate 1
                inline #rewriteHp from to
                locate 3
            1
                locate 6
            2
                locate 6
            3
                alloc size
                copy $Hp size
                val size -6
                locate 4
                while size
                    inline #rewriteHp from to
                    locate 1
                    val size -1
                delete size
                locate 2
        delete ntag
    delete from
    delete to
    inline #heap1Hp

pr !main
    -- PushSC "Halt"
    -- nf 1 [3]
    alloc addr
    inline #heapNewHp addr
    clear $Hp+4
    move addr $Hp+4
    delete addr
    val $Hp 6
    clear $Hp+1
    val $Hp+1 0
    clear $Hp+2
    val $Hp+2 1
    clear $Hp+3
    val $Hp+3 3
    clear $Hp+5
    val $Hp+5 6
    clear $Hp+6
    alloc addr
    copy $Hp+4 addr
    inline #heap1Hp
    inline #stackNewS0
    move addr $S0
    delete addr
    -- Update 1
    alloc to
    move $S0 to
    locate -1
    alloc from
    copy $S0 from
    inline #stack1S0
    while $S0
        inline #rewriteS0 from to
        locate 1
    locate -1
    inline #stack1S0
    while $Hp
        alloc ntag
        copy $Hp+2 ntag
        dispatch ntag
            0
                locate 3
                inline #rewriteHp from to
                locate 1
                inline #rewriteHp from to
                locate 3
            1
                locate 6
            2
                locate 6
            3
                alloc size
                copy $Hp size
                val size -6
                locate 4
                while size
                    inline #rewriteHp from to
                    locate 1
                    val size -1
                delete size
                locate 2
        delete ntag
    delete from
    delete to
    inline #heap1Hp
